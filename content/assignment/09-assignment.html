---
title: "Nonlinear Regression and Model Evaluation"
linktitle: "10: Nonlinear Regression"
output:
  blogdown::html_page:
    toc: true
menu:
  assignment:
    parent: Labs
    weight: 2
type: docs
weight: 1
editor_options:
  chunk_output_type: console
---


<div id="TOC">
<ul>
<li><a href="#backstory-and-set-up" id="toc-backstory-and-set-up">Backstory and Set Up</a></li>
</ul>
</div>

<!-- Updated 11/7/23 fixed data/bank23.csv data no default y is still character, not yet knit -->
<div class="fyi">
<p>You must turn in a PDF document of your <code>R Markdown</code> knitted document. Submit this to D2L by 11:59 PM Eastern Time on March 25th.</p>
</div>
<div id="backstory-and-set-up" class="section level2">
<h2>Backstory and Set Up</h2>
<p>You work for a bank. This bank is trying to predict defaults on loans. These are costly to the bank and, while rare, avoiding them is how banks make money. They’ve given you a dataset on defaults (encoded as the variable <code>default</code>). You’re going to try to predict this (that is, <code>default</code> is your <em>target</em> variable).</p>
<p>This is some new data. The snippet below loads it.</p>
<pre class="r"><code>bank &lt;- read.csv(&quot;https://ssc442kirkpatrick.netlify.app/data/bank23.csv&quot;,
                 stringsAsFactors = FALSE)</code></pre>
<p>There’s not going to be a whole lot of wind-up here. You should be well-versed in doing these sorts of things by now (if not, look back at the previous lab for sample code).</p>
<div class="fyi">
<p><strong>EXERCISE 1</strong></p>
<ol style="list-style-type: decimal">
<li><p>Check the data using <code>skim</code> and <code>str</code> to see what sort of data you have. kNN, as we’ve covered it so far, takes an average of the target variable for the <span class="math inline">\(k\)</span> nearest neighbors. Do any data processing necessary to use kNN to predict <code>default</code>.</p></li>
<li><p>Split the data into an 80/20 train vs. test split. Make sure you explicitly set the seed for replicability, but do not share your seed with others in the class. (We may compare some results across people.)</p></li>
<li><p>Run a series of KNN models with <span class="math inline">\(k\)</span> ranging from 2 to 200. Use whatever variables you think will help predict defaults. Remember, <span class="math inline">\(k\)</span> is our complexity parameter – we do not add or subtract any of the explanatory variables, we vary only <span class="math inline">\(k\)</span>. You must have at least 50 different values of <span class="math inline">\(k\)</span>. You can easily write a short function to do this using this week’s lessons and should avoid hand-coding 50 different models.</p></li>
<li><p>Create a chart plotting the model complexity as the <span class="math inline">\(x\)</span>-axis variable and RMSE as the <span class="math inline">\(y\)</span>-axis variable for <strong>both</strong> the training and test data. Pay attention to the values of <span class="math inline">\(k\)</span> that are “higher” in complexity and “lower” in complexity, and make sure the <span class="math inline">\(x\)</span>-axis is increasing in complexity as you go to the right.</p></li>
<li><p>Answer the following questions:</p></li>
</ol>
<ol style="list-style-type: lower-alpha">
<li><p>What do you think is the optimal <span class="math inline">\(k\)</span>?</p></li>
<li><p>What are you using to decide the optimal <span class="math inline">\(k\)</span>?</p></li>
<li><p>If we were to allow the model a little more complexity than the optimal, how will our training RMSE change? How will our test RMSE change?</p></li>
</ol>
</div>
<p>Below are some code nuggets that you might find helpful. Note that these are <strong>non-functioning</strong>.</p>
<pre class="r"><code>library(caret); library(tidyverse)

bank = bank %&gt;%
  dplyr::mutate(default = case_when(default==&#39;yes&#39; ~ 1,
                                    default==&#39;no&#39; ~ 0))

bX = bank[,c(&#39;balance&#39;, &#39;education&#39;,&#39;job&#39;,&#39;duration&#39;)]
bY = bank[,&#39;default&#39;]

k5 = knnreg(bX, bY, k=5)

k100 = knnreg(default ~ balance + education + job + duration, bank, k=100)
knnreg(default ~ age + education, bank, k=100)
predict(k5, newdata = bank)</code></pre>
<pre class="r"><code>bank = bank23 %&gt;%
  dplyr::mutate(default = case_when(default==&#39;yes&#39; ~ 1,
                                    default==&#39;no&#39; ~ 0))

idx = sample(NROW(bank), round(.8*NROW(bank)), replace=F)
bank_train = bank[idx,]
bank_test = bank[-idx,]

ks &lt;-seq(from=200, to=2, by=-4)

mods&lt;-lapply(ks, function(x){
  knnreg(default ~ age + job + marital + education + balance + duration + campaign, bank_train, k = x)
})


train_rmses = lapply(mods, function(x){
  sqrt(sum((bank_train$default - predict(x, newdata = bank_train))^2)/NROW(bank_train))
})

test_rmses = lapply(mods, function(x){
  sqrt(sum((bank_test$default - predict(x, newdata = bank_test))^2)/NROW(bank_test))
})</code></pre>
</div>
